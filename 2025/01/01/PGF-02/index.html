<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <meta name="theme-color" content="#05324d" />

    <title>ProcGen Fun 2: Composing distributions | DC Coding</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Roboto+Mono:ital,wght@0,400;0,700;1,400;1,700&family=Rubik:ital,wght@0,400;0,700;1,400;1,700&family=Trirong:ital,wght@0,400;0,700;0,900;1,400;1,700;1,900&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="/assets/css/main.css" />
    <link rel="stylesheet" href="/assets/css/code.css" />

    <link
      rel="alternate"
      type="application/rss+xml"
      title="RSS Feed for DC Coding"
      href="/Feed/"
    />
  </head>

  <body class="flex min-h-screen flex-col bg-gray-100">
    <nav class="bg-gray-800">
      <div class="container flex flex-row justify-center px-6">
        
        <a
          class="px-4 py-2 text-lg text-gray-100 hover:bg-gray-700 hover:underline"
          href="/"
          >Home</a
        >
        
        <a
          class="px-4 py-2 text-lg text-gray-100 hover:bg-gray-700 hover:underline"
          href="/Archive"
          >Archive</a
        >
        
        <a
          class="px-4 py-2 text-lg text-gray-100 hover:bg-gray-700 hover:underline"
          href="/About"
          >About</a
        >
        
      </div>
    </nav>

    
 <div class="bg-blue-800">
  <div class="container py-8">
    <h1 class="font-title text-5xl font-bold italic text-gray-50">
      ProcGen Fun 2: Composing distributions
    </h1>
    
    <p class="mt-2 text-lg text-gray-200"> 1 January 2025</p>
    
  </div>
</div>


<div class="container py-6">
  <p class="mb-6 text-3xl italic text-gray-500">How to compose distributions according to functional programming principles.</p>

  <article class="prose"><p>[<a href="/2024/12/18/PGF-00/#list-of-posts">List of posts</a> | <a href="https://github.com/djcarter85/ProcGenFun/tree/post-02">source code for this
post</a>]</p>
<p>In <a href="/2024/12/25/PGF-01/">the last post</a> we introduced the concept of a
distribution as a way of abstracting randomness. Today we'll see how powerful
this abstraction is, as it allows us to compose distributions without
sacrificing functional purity.</p>
<h2>Repeating distributions</h2>
<p>Last time we had this function which repeatedly sampled from a given
distribution.</p>
<pre class="language-cs"><code class="language-cs"><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token generic-method"><span class="token function">TakeSamples</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">,</span> TRng<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>
    <span class="token class-name">IDistribution<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> dist<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> count<span class="token punctuation">,</span> <span class="token class-name">TRng</span> rng<span class="token punctuation">)</span>
    <span class="token keyword">where</span> <span class="token class-name">TRng</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">notnull</span><span class="token punctuation">,</span> <span class="token class-name">IRng</span></span>
<span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">yield</span> <span class="token keyword">return</span> dist<span class="token punctuation">.</span><span class="token function">Sample</span><span class="token punctuation">(</span>rng<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>As we go through this series, we'll aim to put as much code as possible into the
functional core. Looking at the code snippet above, one thing that jumps out at
me is that the idea of repeatedly sampling from a distribution can be classed as
a distribution in and of itself.</p>
<p>So I've extracted an extension method which transforms a single-valued
distribution into a distribution returning multiple values.</p>
<pre class="language-cs"><code class="language-cs"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">DistributionExtensions</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IDistribution<span class="token punctuation">&lt;</span>IEnumerable<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token generic-method"><span class="token function">Repeat</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>
        <span class="token keyword">this</span> <span class="token class-name">IDistribution<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> dist<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> count<span class="token punctuation">)</span> <span class="token operator">=></span>
        <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RepeatDistribution<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span><span class="token punctuation">(</span>dist<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token generic-method"><span class="token function">RepeatDistribution</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name">IDistribution<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> dist<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> count<span class="token punctuation">)</span> <span class="token punctuation">:</span>
        IDistribution<span class="token operator">&lt;</span>IEnumerable<span class="token operator">&lt;</span>T<span class="token operator">>></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token generic-method"><span class="token function">Sample</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRng<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name">TRng</span> rng<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRng</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">notnull</span><span class="token punctuation">,</span> <span class="token class-name">IRng</span></span>
        <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">yield</span> <span class="token keyword">return</span> dist<span class="token punctuation">.</span><span class="token function">Sample</span><span class="token punctuation">(</span>rng<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>This moves more code into the functional core, and allows us to simplify the
call site:</p>
<pre class="language-cs"><code class="language-cs"><span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">DisplayHistogram</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> rng <span class="token operator">=</span> StandardRng<span class="token punctuation">.</span><span class="token function">Create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> dist <span class="token operator">=</span> Uniform<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token number">0d</span><span class="token punctuation">,</span> <span class="token number">1d</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Repeat</span><span class="token punctuation">(</span><span class="token named-parameter punctuation">count</span><span class="token punctuation">:</span> <span class="token number">100_000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">var</span></span> values <span class="token operator">=</span> dist<span class="token punctuation">.</span><span class="token function">Sample</span><span class="token punctuation">(</span>rng<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">DisplayHistogram</span><span class="token punctuation">(</span>values<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>What we've done here is to change the abstraction: instead of having a
distribution and iteratively taking values from it, we now have a distribution
which generates a collection of values in one call. This idea of composing
distributions to make new ones will be important for us, and is very much in
keeping with the ethos of FP.</p>
<h2>Transforming distributions</h2>
<p>In order to display the histogram what we ultimately want is not a collection of
values, but a <code>Histogram</code> object itself. So let's push the idea of composing
distributions one step further, and use the <code>Select()</code> method from RandN to
transform the distribution of value-collections into a distribution of
histograms.</p>
<pre class="language-cs"><code class="language-cs"><span class="token class-name"><span class="token keyword">var</span></span> dist <span class="token operator">=</span>
    Uniform<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token number">0d</span><span class="token punctuation">,</span> <span class="token number">1d</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">Repeat</span><span class="token punctuation">(</span><span class="token named-parameter punctuation">count</span><span class="token punctuation">:</span> <span class="token number">100_000</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>v <span class="token operator">=></span> Histogram<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token named-parameter punctuation">min</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token named-parameter punctuation">max</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<p>This method is called <code>Select()</code> intentionally to match up with <code>Select()</code> from
LINQ. It does the same thing to a distribution as the equivalent LINQ method
does to enumerables; that is, it transforms the type of the distribution using a
function which can be applied to the underlying type.</p>
<p>Although I've chosen not to here, the signature of this method means we could
use C#'s query syntax instead:</p>
<pre class="language-cs"><code class="language-cs"><span class="token class-name"><span class="token keyword">var</span></span> dist <span class="token operator">=</span>
  <span class="token keyword">from</span> v <span class="token keyword">in</span> Uniform<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token number">0d</span><span class="token punctuation">,</span> <span class="token number">1d</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Repeat</span><span class="token punctuation">(</span><span class="token named-parameter punctuation">count</span><span class="token punctuation">:</span> <span class="token number">100_000</span><span class="token punctuation">)</span>
  <span class="token keyword">select</span> Histogram<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>v<span class="token punctuation">,</span> <span class="token named-parameter punctuation">min</span><span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token named-parameter punctuation">max</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>
<h2>Flattening distributions</h2>
<p>Let's turn things up a notch. We can use the <a href="https://en.wikipedia.org/wiki/Box%E2%80%93Muller_transform">Box-Muller
algorithm</a> to
generate a <a href="https://en.wikipedia.org/wiki/Normal_distribution">normal
distribution</a> (also known as
a Gaussian) from two uniformly-distributed values. The obvious way to write this
is with a new class.</p>
<pre class="language-cs"><code class="language-cs"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Normal</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IDistribution<span class="token punctuation">&lt;</span><span class="token keyword">double</span><span class="token punctuation">></span></span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">NormalDistribution</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">NormalDistribution</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token class-name">IDistribution<span class="token punctuation">&lt;</span><span class="token keyword">double</span><span class="token punctuation">></span></span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token return-type class-name"><span class="token keyword">double</span></span> <span class="token generic-method"><span class="token function">Sample</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRng<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name">TRng</span> rng<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRng</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">notnull</span><span class="token punctuation">,</span> <span class="token class-name">IRng</span></span>
        <span class="token punctuation">{</span>
            <span class="token class-name"><span class="token keyword">var</span></span> uniformDist <span class="token operator">=</span> Uniform<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token number">0d</span><span class="token punctuation">,</span> <span class="token number">1d</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            
            <span class="token class-name"><span class="token keyword">var</span></span> u1 <span class="token operator">=</span> uniformDist<span class="token punctuation">.</span><span class="token function">Sample</span><span class="token punctuation">(</span>rng<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name"><span class="token keyword">var</span></span> u2 <span class="token operator">=</span> uniformDist<span class="token punctuation">.</span><span class="token function">Sample</span><span class="token punctuation">(</span>rng<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> 
                Math<span class="token punctuation">.</span><span class="token function">Sqrt</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2.0</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span>u1<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">Cos</span><span class="token punctuation">(</span><span class="token number">2.0</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span>PI <span class="token operator">*</span> u2<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>However, we can make things simpler by using the <code>SelectMany()</code> method. This is
again similar to <code>SelectMany()</code> in LINQ, allowing you to sample from multiple
distributions and flatten the results. This time I think the code is definitely
better off using query syntax than method syntax.</p>
<pre class="language-cs"><code class="language-cs"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Normal</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IDistribution<span class="token punctuation">&lt;</span><span class="token keyword">double</span><span class="token punctuation">></span></span> <span class="token function">New</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span>
        <span class="token keyword">from</span> u1 <span class="token keyword">in</span> Uniform<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token number">0d</span><span class="token punctuation">,</span> <span class="token number">1d</span><span class="token punctuation">)</span>
        <span class="token keyword">from</span> u2 <span class="token keyword">in</span> Uniform<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span><span class="token number">0d</span><span class="token punctuation">,</span> <span class="token number">1d</span><span class="token punctuation">)</span>
        <span class="token keyword">select</span>
            Math<span class="token punctuation">.</span><span class="token function">Sqrt</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">2.0</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">Log</span><span class="token punctuation">(</span>u1<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">*</span> Math<span class="token punctuation">.</span><span class="token function">Cos</span><span class="token punctuation">(</span><span class="token number">2.0</span> <span class="token operator">*</span> Math<span class="token punctuation">.</span>PI <span class="token operator">*</span> u2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>We can again plot this as a histogram:</p>
<p><img src="/assets/images/2025-01-01-PGF-02/normal.png" alt="Histogram of a normal
distribution"></p>
<p>A very satisfying bell curve!</p>
<h2>Conclusion</h2>
<p>We've made a lot of progress so far; these methods for composing and
transforming distributions will be very useful as we go through this series.</p>
<p>However, we can't really say we've done any procedural generation yet. In the
next post we'll start using stochastic algorithms to generate mazes.</p>
</article>
</div>

<div class="container py-6">
  <script
    src="https://utteranc.es/client.js"
    repo="djcarter85/codingblog"
    issue-term="url"
    label="comments"
    theme="github-light"
    crossorigin="anonymous"
    async
  ></script>
</div>


    <footer class="footer mt-auto bg-blue-800 py-4 text-gray-50">
      <div class="container flex flex-col gap-2">
        <div class="flex flex-row justify-center gap-4">
          
          <a
            class="rounded-lg p-2 hover:bg-blue-500"
            href="https://github.com/djcarter85"
            title="GitHub"
          >
            <i class="fab fa-github fa-2x"></i>
          </a>
          
          <a
            class="rounded-lg p-2 hover:bg-blue-500"
            href="/Feed/"
            title="RSS"
          >
            <i class="fa fa-rss fa-2x"></i>
          </a>
          
        </div>
        <div class="text-center">
          &copy; Dan Carter 2024
        </div>
      </div>
    </footer>

    <!-- JS -->
    <script
      defer
      src="https://use.fontawesome.com/releases/v5.6.3/js/all.js"
      integrity="sha384-EIHISlAOj4zgYieurP0SdoiBYfGJKkgWedPHH4jCzpCXLmzVsw1ouK59MuUtP4a1"
      crossorigin="anonymous"
    ></script>

    <script
      type="text/javascript"
      async
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"
    ></script>
  </body>
</html>

<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <meta name="theme-color" content="#05324d" />

    <title>ProcGen Fun 4: Recursive sampling | DC Coding</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Roboto+Mono:ital,wght@0,400;0,700;1,400;1,700&family=Rubik:ital,wght@0,400;0,700;1,400;1,700&family=Trirong:ital,wght@0,400;0,700;0,900;1,400;1,700;1,900&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="/assets/css/main.css" />
    <link rel="stylesheet" href="/assets/css/code.css" />

    <link
      rel="alternate"
      type="application/rss+xml"
      title="RSS Feed for DC Coding"
      href="/Feed/"
    />
  </head>

  <body class="flex min-h-screen flex-col bg-gray-100">
    <nav class="bg-gray-800">
      <div class="container flex flex-row justify-center px-6">
        
        <a
          class="px-4 py-2 text-lg text-gray-100 hover:bg-gray-700 hover:underline"
          href="/"
          >Home</a
        >
        
        <a
          class="px-4 py-2 text-lg text-gray-100 hover:bg-gray-700 hover:underline"
          href="/Archive"
          >Archive</a
        >
        
        <a
          class="px-4 py-2 text-lg text-gray-100 hover:bg-gray-700 hover:underline"
          href="/About"
          >About</a
        >
        
      </div>
    </nav>

    
 <div class="bg-blue-800">
  <div class="container py-8">
    <h1 class="font-title text-5xl font-bold italic text-gray-50">
      ProcGen Fun 4: Recursive sampling
    </h1>
    
    <p class="mt-2 text-lg text-gray-200"> 4 September 2025</p>
    
  </div>
</div>


<div class="container py-6">
  <p class="mb-6 text-3xl italic text-gray-500">Can we implement the "repeat" distribution in a more functional way?</p>

  <article class="prose"><p>[<a href="/2024/12/18/PGF-00/#list-of-posts">List of posts</a> | <a href="https://github.com/djcarter85/ProcGenFun/tree/post-04">source code for this
post</a>]</p>
<p>In <a href="/2025/01/01/PGF-02">a previous post</a> we implemented a function which
transforms a single-valued distribution into a distribution returning multiple
values, as follows.</p>
<pre class="language-cs"><code class="language-cs"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IDistribution<span class="token punctuation">&lt;</span>IEnumerable<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token generic-method"><span class="token function">Repeat</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>
    <span class="token keyword">this</span> <span class="token class-name">IDistribution<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> dist<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> count<span class="token punctuation">)</span> <span class="token operator">=></span>
    <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RepeatDistribution<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span><span class="token punctuation">(</span>dist<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token generic-method"><span class="token function">RepeatDistribution</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name">IDistribution<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> dist<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> count<span class="token punctuation">)</span> <span class="token punctuation">:</span>
    IDistribution<span class="token operator">&lt;</span>IEnumerable<span class="token operator">&lt;</span>T<span class="token operator">>></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> <span class="token generic-method"><span class="token function">Sample</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>TRng<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token class-name">TRng</span> rng<span class="token punctuation">)</span> <span class="token keyword">where</span> <span class="token class-name">TRng</span> <span class="token punctuation">:</span> <span class="token type-list"><span class="token keyword">notnull</span><span class="token punctuation">,</span> <span class="token class-name">IRng</span></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> count<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">yield</span> <span class="token keyword">return</span> dist<span class="token punctuation">.</span><span class="token function">Sample</span><span class="token punctuation">(</span>rng<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>At the time I should have added argument validation, so let's do that quickly:</p>
<pre class="language-cs"><code class="language-cs"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IDistribution<span class="token punctuation">&lt;</span>IEnumerable<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token generic-method"><span class="token function">Repeat</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>
    <span class="token keyword">this</span> <span class="token class-name">IDistribution<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> dist<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> count<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentOutOfRangeException</span><span class="token punctuation">(</span>
            <span class="token keyword">nameof</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">,</span> count<span class="token punctuation">,</span> <span class="token string">"Count must be non-negative"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RepeatDistribution<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span><span class="token punctuation">(</span>dist<span class="token punctuation">,</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>When I first wrote this function, it irked me a little that we had to introduce
a new class to implement it. Granted, the extra class is private, and so can't
be seen outside by anyone using the <code>Repeat</code> method, but it would be nice to try
and implement this using a more functional approach.</p>
<p>Well, today I had a brainwave - use
<a href="https://en.wikipedia.org/wiki/Recursion_(computer_science)">recursion</a>! Here's
my refactored version, in all its glory:</p>
<pre class="language-cs"><code class="language-cs"><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token return-type class-name">IDistribution<span class="token punctuation">&lt;</span>IEnumerable<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span><span class="token punctuation">></span></span> <span class="token generic-method"><span class="token function">Repeat</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span>
    <span class="token keyword">this</span> <span class="token class-name">IDistribution<span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span> dist<span class="token punctuation">,</span> <span class="token class-name"><span class="token keyword">int</span></span> count<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">ArgumentOutOfRangeException</span><span class="token punctuation">(</span>
            <span class="token keyword">nameof</span><span class="token punctuation">(</span>count<span class="token punctuation">)</span><span class="token punctuation">,</span> count<span class="token punctuation">,</span> <span class="token string">"Count must be non-negative"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Singleton<span class="token punctuation">.</span><span class="token function">New</span><span class="token punctuation">(</span>Enumerable<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Empty</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>T<span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span>
        <span class="token keyword">from</span> values <span class="token keyword">in</span> dist<span class="token punctuation">.</span><span class="token function">Repeat</span><span class="token punctuation">(</span>count <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token keyword">from</span> <span class="token keyword">value</span> <span class="token keyword">in</span> dist
        <span class="token keyword">select</span> values<span class="token punctuation">.</span><span class="token function">Append</span><span class="token punctuation">(</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>We start with the base case: if the caller has asked for a count of zero, then
they will always get an empty sequence. For this we can use a singleton
distribution.</p>
<p>In the general case, we can use the same function to generate all but the last
value, and then sample from the distribution once and append it to the result.
Using query syntax for this works quite well I think, as it's clear that we're
building up the resultant distribution from simpler ones.</p>
<p>Let's just test it out quickly, to make sure we haven't broken anything. I'll
open the &quot;visualise distributions&quot; screen from post 1 as that uses the <code>Repeat</code>
method to generate a large number of samples.</p>
<p><img src="/assets/images/2025-09-04-PGF-04/error.png" alt="Screenshot of a
StackOverflowException"></p>
<p>Oh dear! By implementing this using recursion instead of a loop, we've made it
so that sampling from the distribution uses up one frame on the stack per sample
we need. I'm asking for 100,000 samples here, which blows way past the limit of
around 7000 that C# allows.</p>
<p>So why didn't this work? Isn't this how you would implement an algorithm like
this in functional languages like Haskell or F#? The key is that if a function
is <a href="https://en.wikipedia.org/wiki/Tail_call">tail recursive</a> (the final
statement in a function contains a call to itself) then it's possible for the
recursion to be replaced with a loop. In many languages the compiler does this
for you to avoid exceptions like this; C# happens not to be one of them!</p>
<p>So, alas, my grand idea of implementing this using recursion has failed. Never
mind; often in programming you have to compromise on your lofty theoretical
goals in order to make something that actually works. Let's revert these changes
and move on. Next time I'll fulfil my promise of more mazes!</p>
</article>
</div>

<div class="container py-6">
  <script
    src="https://utteranc.es/client.js"
    repo="djcarter85/codingblog"
    issue-term="url"
    label="comments"
    theme="github-light"
    crossorigin="anonymous"
    async
  ></script>
</div>


    <footer class="footer mt-auto bg-blue-800 py-4 text-gray-50">
      <div class="container flex flex-col gap-2">
        <div class="flex flex-row justify-center gap-4">
          
          <a
            class="rounded-lg p-2 hover:bg-blue-500"
            href="https://github.com/djcarter85"
            title="GitHub"
          >
            <i class="fab fa-github fa-2x"></i>
          </a>
          
          <a
            class="rounded-lg p-2 hover:bg-blue-500"
            href="/Feed/"
            title="RSS"
          >
            <i class="fa fa-rss fa-2x"></i>
          </a>
          
        </div>
        <div class="text-center">
          &copy; Dan Carter 2025
        </div>
      </div>
    </footer>

    <!-- JS -->
    <script
      defer
      src="https://use.fontawesome.com/releases/v5.6.3/js/all.js"
      integrity="sha384-EIHISlAOj4zgYieurP0SdoiBYfGJKkgWedPHH4jCzpCXLmzVsw1ouK59MuUtP4a1"
      crossorigin="anonymous"
    ></script>

    <script
      type="text/javascript"
      async
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"
    ></script>
  </body>
</html>

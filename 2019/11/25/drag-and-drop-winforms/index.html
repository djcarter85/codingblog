<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">

  <title>Drag-and-drop in Windows Forms is as easy as 1-2-3 (and maybe 4) | DC Coding</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Roboto+Mono:ital,wght@0,400;0,700;1,400;1,700&family=Rubik:ital,wght@0,400;0,700;1,400;1,700&family=Trirong:ital,wght@0,400;0,700;0,900;1,400;1,700;1,900&display=swap"
    rel="stylesheet">

  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="stylesheet" href="/assets/css/code.css">

  <link rel="alternate" type="application/rss+xml" title="RSS Feed for DC Coding" href="/Feed/" />

</head>

<body class="bg-gray-100 min-h-screen flex flex-col">
  
  <nav class="bg-gray-800">
    <div class="container flex flex-row justify-center px-6">
      
      <a class="text-gray-100 text-lg px-4 py-2 hover:bg-gray-700 hover:underline" href="/">Home</a>
      
      <a class="text-gray-100 text-lg px-4 py-2 hover:bg-gray-700 hover:underline" href="/Archive">Archive</a>
      
      <a class="text-gray-100 text-lg px-4 py-2 hover:bg-gray-700 hover:underline" href="/About">About</a>
      
      <a class="text-gray-100 text-lg px-4 py-2 hover:bg-gray-700 hover:underline" href="/Subscribe">Subscribe</a>
      
    </div>
  </nav>

  

<div class="bg-blue-800">
  <div class="container py-8">
    <h1 class="text-gray-50 text-6xl font-title font-bold italic">Drag-and-drop in Windows Forms is as easy as 1-2-3 (and maybe 4)</h1>
    
    <p class="text-gray-200 text-lg mt-2">25 November 2019</p>
    
  </div>
</div>

<div class="container py-6">
  <p class="text-3xl italic text-gray-500 mb-6">How to support drag-and-drop in Windows Forms.</p>

  <article class="prose">
    <p>Last week I was writing a Windows Forms application that needed to process data
that had been dragged onto it.</p>
<p>This sent me down a (small) rabbit hole. Supporting drag and drop was not quite
as straightforward as I initially thought!</p>
<p>Here's how to do it, broken down into a few manageable steps.</p>
<h2>1. Allow drag-and-drop on the control</h2>
<p>Set the <code>AllowDrop</code> property to <code>true</code> on the control which data can be dragged
onto. If you don't do this, then the events detailed below won't fire.</p>
<p>This may be the whole form, or perhaps a label saying &quot;drop here&quot;.</p>
<h2>2. Handle the &quot;enter&quot; event</h2>
<p>The <code>DragEnter</code> event fires when data is dragged over the control in question.
That is, the mouse enters the control's bounds while the left button is pressed
and the user is dragging something.</p>
<p>This event uses <code>DragEventArgs</code>, which has the property <code>AllowedEffect</code>. This is
a flags enum containing all the different &quot;effects&quot; (<a href="https://docs.microsoft.com/en-us/dotnet/api/system.windows.forms.dragdropeffects?view=netframework-4.8">Link, Copy,
Move</a>)
allowed by the source of the drag. For example, if you drag a file from Windows
File Explorer, you're allowed to link or copy but not move.</p>
<p>In the event handler, you need to set the value of <code>DragEventArgs.Effect</code> to one
of the allowed values. This does two things:</p>
<ul>
<li>Changes the cursor to provide a visual cue to the user that drag-and-drop is
possible (the default is a &quot;no entry&quot; cursor to indicate that drag-and-drop is
not supported). The exact cursor used depends on which value you choose.</li>
<li>Sets up the <code>DragDrop</code> event to fire if/when the user releases the left mouse
button (see below).</li>
</ul>
<p>If you want to make a bigger visual change than just the cursor (e.g. change the
appearance of the control), then you should also do that in the <code>DragEnter</code>
event handler.</p>
<h2>3. Handle the &quot;drop&quot; event</h2>
<p>The <code>DragDrop</code> event fires when the user releases the mouse to drop data onto
the control.</p>
<p>The data that has been dragged can be found in <code>DragEventArgs.Data</code>. This is an
<code>IDataObject</code>, which contains the data in a number of &quot;formats&quot;. The exact
formats used will depend on where the data was dragged from, so when developing
there's a bit of trial and error to see which formats are appropriate for you to
use.</p>
<p>Some helpful methods on <code>IDataObject</code>:</p>
<ul>
<li><code>GetFormats()</code>: this returns a <code>string[]</code>, each item of which is the name of a
format the data can be provided in.</li>
<li><code>GetData(string format)</code>: this returns the data in the specified format.
Because this method returns <code>object</code>, you'll have to cast it before using it.
If <code>format</code> is not recognised, it returns <code>null</code>.</li>
<li><code>GetDataPresent(string format)</code>: this returns a <code>bool</code> indicating whether the
data is present in the specified format. This method could be used in the
<code>DragEnter</code> event handler to determine whether to enable drag-and-drop at all.</li>
</ul>
<p>As an example, one of the formats when dragging data from Windows File Explorer
was <code>&quot;FileName&quot;</code>. If you call <code>GetData(&quot;FileName&quot;)</code> then you get a <code>string[]</code>
containing the full paths of the files being dragged.</p>
<p>Once you have the data you want you can then do whatever you like. For example,
my application reads in the file, transforms it, and puts the result in a text
box.</p>
<p>This event also uses <code>DragEventArgs</code>, and it uses the same instance as the one
provided in <code>DragEnter</code>, meaning you can inspect the value you chose for
<code>Effect</code> if you need to.</p>
<h2>4. Handle the &quot;leave&quot; event (maybe)</h2>
<p>The <code>DragLeave</code> event fires when the mouse leave the bounds of the control and
the user is still dragging the item.</p>
<p>Handling this event is only necessary if you need to tidy up from the
<code>DragEnter</code> event; perhaps you need to reset some visuals to indicate that
releasing the mouse won't complete the drag-and-drop operation.</p>
<h2>Example</h2>
<p>The following example shows you how to accept files dragged from File Explorer.
It captures a file dragged onto <code>dragDropLabel</code> and displays the file contents
in <code>outputTextBox</code>.</p>
<pre class="language-cs"><code class="language-cs"><span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Linq</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token namespace">System<span class="token punctuation">.</span>Windows<span class="token punctuation">.</span>Forms</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">dragDropLabel_DragEnter</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">DragEventArgs</span> e<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>AllowedEffect<span class="token punctuation">.</span><span class="token function">HasFlag</span><span class="token punctuation">(</span>DragDropEffects<span class="token punctuation">.</span>Copy<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
        e<span class="token punctuation">.</span>Data<span class="token punctuation">.</span><span class="token function">GetData</span><span class="token punctuation">(</span><span class="token string">"FileName"</span><span class="token punctuation">)</span> <span class="token keyword">is</span> <span class="token class-name"><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span></span> fileNames <span class="token operator">&amp;&amp;</span>
        fileNames<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        e<span class="token punctuation">.</span>Effect <span class="token operator">=</span> DragDropEffects<span class="token punctuation">.</span>Copy<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token return-type class-name"><span class="token keyword">void</span></span> <span class="token function">dragDropLabel_DragDrop</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">object</span></span> sender<span class="token punctuation">,</span> <span class="token class-name">DragEventArgs</span> e<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> fileNames <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>e<span class="token punctuation">.</span>Data<span class="token punctuation">.</span><span class="token function">GetData</span><span class="token punctuation">(</span><span class="token string">"FileName"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name"><span class="token keyword">var</span></span> fileName <span class="token operator">=</span> fileNames<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">this</span><span class="token punctuation">.</span>outputTextBox<span class="token punctuation">.</span>Text <span class="token operator">=</span> File<span class="token punctuation">.</span><span class="token function">ReadAllText</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<h2>Appendix: exploring the data</h2>
<p>While developing, the following snippet was useful for discovering what formats
were supported by <code>DragEventArgs.Data</code> and exactly how the data looked.</p>
<pre class="language-cs"><code class="language-cs"><span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> format <span class="token keyword">in</span> e<span class="token punctuation">.</span>Data<span class="token punctuation">.</span><span class="token function">GetFormats</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> data <span class="token operator">=</span> e<span class="token punctuation">.</span>Data<span class="token punctuation">.</span><span class="token function">GetData</span><span class="token punctuation">(</span>format<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token class-name"><span class="token keyword">string</span></span> text<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>data <span class="token keyword">is</span> <span class="token class-name">MemoryStream</span> ms<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">var</span></span> sr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">StreamReader</span><span class="token punctuation">(</span>ms<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            text <span class="token operator">=</span> sr<span class="token punctuation">.</span><span class="token function">ReadToEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        text <span class="token operator">=</span> data<span class="token punctuation">?.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    System<span class="token punctuation">.</span>Diagnostics<span class="token punctuation">.</span>Debug<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token interpolation-string"><span class="token string">$"</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">format</span><span class="token punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token punctuation">{</span><span class="token expression language-csharp">text</span><span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>

  </article>
</div>

<div class="container py-6">
  <script src="https://utteranc.es/client.js" repo="djcarter85/codingblog" issue-term="url" label="comments"
    theme="github-light" crossorigin="anonymous" async></script>
</div>
  
  <footer class="footer mt-auto py-4 bg-blue-800 text-gray-50">
    <div class="container flex flex-col gap-2">
      <div class="flex flex-row gap-4 justify-center">
        
        <a class="p-2 rounded-lg hover:bg-blue-500" href="https://github.com/djcarter85" title="GitHub">
          <i class="fab fa-github fa-2x"></i>
        </a>
        
        <a class="p-2 rounded-lg hover:bg-blue-500" href="/Feed/" title="RSS">
          <i class="fa fa-rss fa-2x"></i>
        </a>
        
      </div>
      <div class="text-center">
        &copy; Dan Carter 2023
      </div>
    </div>
  </footer>
  
  <!-- JS -->
  <script defer src="https://use.fontawesome.com/releases/v5.6.3/js/all.js"
    integrity="sha384-EIHISlAOj4zgYieurP0SdoiBYfGJKkgWedPHH4jCzpCXLmzVsw1ouK59MuUtP4a1" crossorigin="anonymous"></script>
  
  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"> </script>

</body>

</html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta name="theme-color" content="#05324d">

  <title>A nullable is like a simple enumerable | DC Coding</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Libre+Baskerville:ital,wght@0,400;0,700;1,400&family=Roboto+Mono:ital,wght@0,400;0,700;1,400;1,700&family=Rubik:ital,wght@0,400;0,700;1,400;1,700&family=Trirong:ital,wght@0,400;0,700;0,900;1,400;1,700;1,900&display=swap"
    rel="stylesheet">

  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="stylesheet" href="/assets/css/code.css">

  <link rel="alternate" type="application/rss+xml" title="RSS Feed for DC Coding" href="/Feed/" />

</head>

<body class="bg-gray-100 min-h-screen flex flex-col">
  
  <nav class="bg-gray-800">
    <div class="container flex flex-row justify-center px-6">
      
      <a class="text-gray-100 text-lg px-4 py-2 hover:bg-gray-700 hover:underline" href="/">Home</a>
      
      <a class="text-gray-100 text-lg px-4 py-2 hover:bg-gray-700 hover:underline" href="/Archive">Archive</a>
      
      <a class="text-gray-100 text-lg px-4 py-2 hover:bg-gray-700 hover:underline" href="/About">About</a>
      
      <a class="text-gray-100 text-lg px-4 py-2 hover:bg-gray-700 hover:underline" href="/Subscribe">Subscribe</a>
      
    </div>
  </nav>

  

<div class="bg-blue-800">
  <div class="container py-8">
    <h1 class="text-gray-50 text-6xl font-title font-bold italic">A nullable is like a simple enumerable</h1>
    
    <p class="text-gray-200 text-lg mt-2">30 October 2022</p>
    
  </div>
</div>

<div class="container py-6">
  <p class="text-3xl italic text-gray-500 mb-6">An equivalence between two .NET types which comes in handy when refactoring.</p>

  <article class="prose">
    <p>Here's a fact about two .NET types:</p>
<blockquote>
<p>A <code>Nullable&lt;T&gt;</code> is equivalent to an <code>IEnumerable&lt;T&gt;</code> with either zero or one
elements.</p>
</blockquote>
<p>That is, suppose you have a variable <code>x</code> of type <code>Nullable&lt;T&gt;</code> for some value
type <code>T</code> (sometimes written <code>T?</code>). Then:</p>
<ul>
<li>If <code>x.HasValue</code> is <code>false</code>, then it's equivalent to an <code>IEnumerable&lt;T&gt;</code> with
zero elements.</li>
<li>If <code>x.HasValue</code> is <code>true</code>, then it's equivalent to an <code>IEnumerable&lt;T&gt;</code> with
one element.</li>
</ul>
<p>Note that this only works for value types, as <code>Nullable&lt;T&gt;</code> is only defined if
<code>T</code> is a value type. However, you could apply the same principle to reference
types, especially if you're using <a href="https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/builtin-types/nullable-reference-types">nullable reference
types</a>
in C# 8 or newer.</p>
<p>This realisation came in handy recently when I was refactoring some code. Here's
a trimmed down example to explain how this is useful.</p>
<h2>Example</h2>
<p>Suppose your code has a function which returns a nullable:</p>
<pre class="language-cs"><code class="language-cs"><span class="token return-type class-name"><span class="token keyword">int</span><span class="token punctuation">?</span></span> <span class="token function">GetNullableNumber</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> text<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">// The implementation of this method is less important than the return type</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">.</span><span class="token function">TryParse</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">int</span></span> <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>Then when you call it, it only makes sense to perform an action (e.g. saving to
a database) if the nullable has a value:</p>
<pre class="language-cs"><code class="language-cs"><span class="token comment">// Assume GetText() is defined elsewhere</span>
<span class="token class-name"><span class="token keyword">var</span></span> text <span class="token operator">=</span> <span class="token function">GetText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name"><span class="token keyword">var</span></span> nullableNumber <span class="token operator">=</span> <span class="token function">GetNullableNumber</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// This condition could equivalently be written nullableNumber != null</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>nullableNumber<span class="token punctuation">.</span>HasValue<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name"><span class="token keyword">var</span></span> number <span class="token operator">=</span> nullableNumber<span class="token punctuation">.</span>Value<span class="token punctuation">;</span>
    <span class="token function">SaveNumberToDatabase</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>Suppose you now want to support a <code>text</code> value that could contain multiple
numbers (perhaps comma-separated). To make this new functionality easier, we can
do an initial refactor like so:</p>
<pre class="language-cs"><code class="language-cs"><span class="token return-type class-name">IEnumerable<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">></span></span> <span class="token function">GetNumbers</span><span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">string</span></span> text<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">.</span><span class="token function">TryParse</span><span class="token punctuation">(</span>text<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name"><span class="token keyword">int</span></span> <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">List<span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">value</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">else</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Enumerable<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Empty</span><span class="token generic class-name"><span class="token punctuation">&lt;</span><span class="token keyword">int</span><span class="token punctuation">></span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre>
<p>And then the call site becomes:</p>
<pre class="language-cs"><code class="language-cs"><span class="token class-name"><span class="token keyword">var</span></span> text <span class="token operator">=</span> <span class="token function">GetText</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name"><span class="token keyword">var</span></span> numbers <span class="token operator">=</span> <span class="token function">GetNumbers</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token keyword">int</span></span> number <span class="token keyword">in</span> numbers<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token function">SaveNumberToDatabase</span><span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code></pre>
<p>From here, we can go on to add the new parsing functionality to <code>GetNumbers()</code>.</p>
<h2>Conclusion</h2>
<p>This works because of the fact we started with:</p>
<blockquote>
<p>A <code>Nullable&lt;T&gt;</code> is equivalent to an <code>IEnumerable&lt;T&gt;</code> with either zero or one
elements.</p>
</blockquote>
<p>To refactor from nullable to enumerable, replace any <code>HasValue</code> (or <code>!= null</code>)
checks with a <code>foreach</code>.</p>
<p>It's worth pointing out that I don't necessarily think that the <code>foreach</code> is
more readable; in fact, in the above example I think it's less readable! The
point I'm trying to make is that you <em>can</em> perform this refactor, often with a
view to then supporting a collection of any number of elements.</p>
<p>If you really want to get nerdy about this, the reason that this works is that
<code>Nullable&lt;T&gt;</code> and <code>IEnumerable&lt;T&gt;</code> are both <strong>functors</strong>. But perhaps that's a
topic for another time ...</p>

  </article>
</div>

<div class="container py-6">
  <script src="https://utteranc.es/client.js" repo="djcarter85/codingblog" issue-term="url" label="comments"
    theme="github-light" crossorigin="anonymous" async></script>
</div>
  
  <footer class="footer mt-auto py-4 bg-blue-800 text-gray-50">
    <div class="container flex flex-col gap-2">
      <div class="flex flex-row gap-4 justify-center">
        
        <a class="p-2 rounded-lg hover:bg-blue-500" href="https://github.com/djcarter85" title="GitHub">
          <i class="fab fa-github fa-2x"></i>
        </a>
        
        <a class="p-2 rounded-lg hover:bg-blue-500" href="/Feed/" title="RSS">
          <i class="fa fa-rss fa-2x"></i>
        </a>
        
      </div>
      <div class="text-center">
        &copy; Dan Carter 2023
      </div>
    </div>
  </footer>
  
  <!-- JS -->
  <script defer src="https://use.fontawesome.com/releases/v5.6.3/js/all.js"
    integrity="sha384-EIHISlAOj4zgYieurP0SdoiBYfGJKkgWedPHH4jCzpCXLmzVsw1ouK59MuUtP4a1" crossorigin="anonymous"></script>
  
  <script type="text/javascript" async
    src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"> </script>

</body>

</html>